# FHIR Model Generation Tool for Davinci Drug Formularity Extensions
- This project is to add support for USDF extensions in FHIR. Currently, under development.

This module reads FHIR definition flies and generate model classes for FHIR resources, types and codemaps.
It uses the HL7-provided specification artifacts, and the generates java classes to `fhir-model`.

Model classes and required parsers can be generated using this tool. Original source has been modified in order to 
support Davinci Drug Formularity extensions.

## Clone and Generate Swagger/Open API Definitions
Clone the repo.

Build the following modules

    fhir-examples , fhir-core , fhir-search , fhir-path ,  fhir-validation , fhir-profile
    
Build `fhir-model` and then `fhir-swagger-generator`

Go to `/target` folder in `fhir-swagger-generator` and execute the jar.

    java -jar fhir-swagger-generator-<RELEASE>-cli.jar
    
    java -cp fhir-swagger-generator-<RELEASE>-cli.jar com.ibm.fhir.swagger.generator.FHIRSwaggerGenerator 
 


## Add New Resource Definition and Build

Put Davinci Drug Formularity artifacts in folder named ./extensions and place it in the root directory of 
fhir-tool module.
Then go to fhir-tools module, execute:

```
mvn clean install
```

The repo should successfully build without any errors. 

Then navigate to root directory which contains all the modules. (/FHIR) 

```
cd ..
```

Execute the following command to generate model classes in `fhir-model` module.

```
mvn com.ibm.fhir:fhir-tools:generate-model -f ./fhir-model/pom.xml
```

The repo should successfully build without any errors.

You can skip the checkstyle plugin by adding the following flag to the command.

```
-Dcheckstyle.skip
```

## Build `fhir-model`

Before executing the build command, verify whether the new resource files are added properly. 

You need to modify `fhir-model/src/main/java/com/ibm/fhir/model/type/code/ResourceType.java` as follows.

Add following lines to `ValueSet` enum
`COVERAGEPLAN("CoveragePlan")`

`FORMULARYDRUG("FormularyDrug")`

Then add following methods 

`public static final ResourceType COVERAGEPLAN = ResourceType.builder().value(ValueSet.COVERAGEPLAN).build();`

`public static final ResourceType FORMULARYDRUG = ResourceType.builder().value(ValueSet.FORMULARYDRUG).build();`

Comment the following line from `parseDomainResource` method in FHIRJsonParser.java
        
        `builder.text(parseNarrative("text", getJsonValue(jsonObject, "text", JsonObject.class), -1));`

and add the following condition

    if (!jsonObject.getString("name").equals("CoveragePlan") && !jsonObject.getString("name").equals("FormularyDrug")) {
            builder.text(parseNarrative("text", getJsonValue(jsonObject, "text", JsonObject.class), -1));
        }

Now you can build the `fhir-model` by executing following command in `fhir-model` root directory.
But as we manually modified autogenerated files, there can be test failures.

`mvn clean install`

To skip tests,

`mvn clean install -Dmaven.test.skip=true`

## Generating Swagger Definitions
First, build the required modules together with updated Model classes.

Follow the instructions in `fhir-swagger-genrator` readme.


