# IBM FHIR Server - fhir-persistence-schema

Builds and manages the multi-tenant FHIR R4 RDBMS schema for Db2 and PostgreSQL and includes Derby support for testing.

This module is built into two different jar files. The default jar is included with the IBM FHIR Server web application and is used for bootstrapping Apache Derby databases (if configured). There is also an executable command line interface (cli) version of this jar that packages this module with all of its dependencies.

The executable command line interface (cli) version of this module can be downloaded from the project [Releases tab](https://github.com/IBM/FHIR/releases).

## Getting started
### Creating the database and user

To create the Db2 database and database user, use the following commands:

``` shell
useradd fhirserver
su - db2inst1 -c "db2 CREATE DB FHIRDB using codeset UTF-8 territory us PAGESIZE 32768"
su - db2inst1 -c "db2 \"connect to fhirdb\" && db2 \"grant connect on database TO USER fhirserver\""
```

To create the PostgreSql database and database user, use the following commands:

``` shell
psql postgres
>postgres=# create database fhirdb;
>postgres=# create user fhirserver with password 'change-password';
>postgres=# grant all privileges on database fhirdb to fhirserver;
```

### Printing the schema

To print the schema DDL for review, execute `com.ibm.fhir.schema.app.SchemaPrinter`:

``` shell
java -cp ./fhir-persistence-schema-${VERSION}-cli.jar com.ibm.fhir.schema.app.SchemaPrinter [--to-file]
```

Note: Replace `${VERSION}` with the version of the jar you're using or use the wildcard `*` to match any version.

With `--to-file` it outputs to `./schema.sql`, `./grants.sql`, and `./stored-procedures.sql`; otherwise to System.out.

### Connection properties

The `fhir-persistence-schema` tool uses a properties file for database connection information.

|Property|Description|
|--------|-----------|
|db.host | The database server hostname|
|db.port | The database server port|
|db.database | The name of the database|
|user | A username with connect and admin permissions on the target database|
|password | The user password for connecting to the database|
|sslConnection | true or anything else, true triggers JDBC to use ssl, an example --prop sslConnection=true |

A sample properties file can be found at https://github.com/IBM/FHIR/blob/master/fhir-persistence-schema/db2.properties

Alternatively, properties may be passed via the command line interface `--prop` flag (`--prop <propname>=<propvalue>`). The flag can be repeated for setting multiple properties.

## Execute the fhir-persistence-schema command line interface (CLI)

To deploy and manage the schema on a target database, the `fhir-persistence-schema` project includes a Main class that can parallelize the schema updates.

``` shell
java -jar ./fhir-persistence-schema-${VERSION}-cli.jar [OPTIONS]
```

Note: Replace `${VERSION}` with the version of the jar you're using or use the wildcard `*` to match any version.

The following sections include common values for `OPTIONS`.

### Drop tables from FHIR_ADMIN and FHIRDATA (Db2 only)

```
--prop-file db2.properties
--schema-name FHIRDATA
--drop-schema
--drop-admin
--confirm-drop
```

### Create new schema
For Db2:

```
--prop-file db2.properties
--schema-name FHIRDATA
--create-schemas
```

For Postgresql:

```
--prop-file postgresql.properties
--schema-name fhirdata
--create-schemas
--db-type postgresql
```

### Deploy new schema
For Db2:

```
--prop-file db2.properties
--schema-name FHIRDATA
--update-schema
```
For Postgresql:

```
--prop-file postgresql.properties
--schema-name fhirdata
--update-schema
--db-type postgresql
```

### Grant privileges to data access user (Db2 only)

```
--prop-file db2.properties
--schema-name FHIRDATA
--grant-to FHIRSERVER
```

### Add a new tenant (e.g. default)  (Db2 only)

Don't forget to copy the tenant-key secret generated by --allocate-tenant. This key must be added to the datasource configuration to authorize the FHIR server to access this tenant.

```
--prop-file db2.properties
--schema-name FHIRDATA
--allocate-tenant default
```

Use `--tenant-key-file tenant.key.file` to direct the action to read the tenant-key from file.  If the file exists the tenant key (up to 44 characters) is read from the file.  If the file does not exist, the generated tenantKey is written out to the file.

Note: for tenant names other than `default`, the server must determine the tenant id to use for each request.
By default, we get the tenant id from the `X-FHIR-TENANT-ID` header, but to trust this value requires a well-planned approach to security.
Once the server has determined the tenant id for a given request, it uses this to look up the tenantKey and the two are
used in conjunction to create or retrieve data for this tenant.
For more information on multi-tenancy, see section [4.9 Multi-tenancy of the IBM FHIR Server Users Guide](https://ibm.github.io/FHIR/guides/FHIRServerUsersGuide#49-multi-tenancy).

### Configure tenant-key (example)  (Db2 only)

Edit `wlp/usr/servers/fhir-server/config/default/fhir-server-config.json` and add the tenant-key captured from the add-tenant step above:

```
                "default": {
                    "tenantKey": "<the-base64-tenant-key>",
                    "type": "db2",
                    "connectionProperties": {
                        "serverName": "<db2-host-name>",
                        "portNumber": 50001,
                        "databaseName": "BLUDB",
                        "apiKey": "<your-db2-api-key>",
                        "securityMechanism": 15,
                        "pluginName": "IBMIAMauth",
                        "currentSchema": "FHIRDATA",
                        "driverType": 4,
                        "sslConnection": true,
                        "sslTrustStoreLocation": "resources/security/dbTruststore.jks",
                        "sslTrustStorePassword": "<your-ssl-truststore-password>"
                    }
                }
```


### Test a tenant (Db2 only)

```
--prop-file db2.properties
--schema-name FHIRDATA
--test-tenant default
--tenant-key "<the-base64-tenant-key>"
```

Use `--tenant-key-file tenant.key` to read the tenant-key to a file. You do not need `--tenant-key` if you use the file.

### Add a Key to Existing Tenant (Db2 only)
To add a tenant key for an existing tenant, replace FHIRDATA with your client schema, and change default to your tenant's name. 

```
--prop-file db2.properties
--schema-name FHIRDATA
--add-tenant-key default
```

**Example Output**
```
2020-03-24 13:54:36.387 00000001    INFO .common.JdbcConnectionProvider Opening connection to database: jdbc:db2://localhost:50000/FHIRDB
2020-03-24 13:54:37.012 00000001    INFO   com.ibm.fhir.schema.app.Main New tenant key: TNT1 [key=LogFbM06+PLS1cur/NOTREALg=]
2020-03-24 13:54:37.014 00000001    INFO   com.ibm.fhir.schema.app.Main Processing took:   0.637 s
2020-03-24 13:54:37.015 00000001    INFO   com.ibm.fhir.schema.app.Main SCHEMA CHANGE: OK
```

Note, you may want to add a tenant key when a key is lost or needs to be changed.

Use `--tenant-key-file tenant.key.file` to direct the action to read the tenant-key from file.  If the file exists the tenant key (up to 44 characters is read from the file.  If the file does not exist, the generated tenantKey is written out to the file.

### Update the stored procedures and functions for FHIRDATA (and not FHIR_ADMIN) (Db2 and PostgreSQL)

For Db2:

```
--prop-file db2.properties
--schema-name FHIRDATA
--update-proc
```

For postgresql:

```
--prop-file postgresql.properties
--schema-name fhirdata
--update-proc
--db-type postgresql
```

## Alternative: manually apply the schema

To manually apply the DDL to a Db2 instance:

1 - Print the schema to files by executing the SchemaPrinter:

*Linux/Mac*  

```
VERSION=4.0.1
java -jar ./fhir-persistence-schema-${VERSION}-cli.jar --to-file
```

*Windows*

```
set VERSION=4.0.1
java -jar ./fhir-persistence-schema-%VERSION%-cli.jar --to-file
```

Note: the jar file is stored locally in `fhir-persistence-schema/target` or in the Artifactory repository for this project.

2 - Connect to your instance and execute each of the following:
    - schema.sql:  `db2 -tvf schema.sql`
    - grants.sql:  `db2 -tvf grants.sql`
    - stored-procedures.sql:  `db2 -td@ -vf stored-procedures.sql`

FHIRÂ® is the registered trademark of HL7 and is used with the permission of HL7.
